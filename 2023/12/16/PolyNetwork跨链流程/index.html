<!DOCTYPE html>
<html lang="en">
<head>
<!--pjax：防止跳转页面音乐暂停-->
 <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/hometown.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/hometown.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"emmanuelwh.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":280,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}},"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="摘要：Poly Network跨链流程">
<meta property="og:type" content="article">
<meta property="og:title" content="PolyNetwork跨链流程">
<meta property="og:url" content="https://emmanuelwh.github.io/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="来自门头沟学院的Emmanuel">
<meta property="og:description" content="摘要：Poly Network跨链流程">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-12-16T03:42:01.000Z">
<meta property="article:modified_time" content="2023-12-16T03:43:18.806Z">
<meta property="article:author" content="Emmanuel">
<meta property="article:tag" content="跨链桥">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://emmanuelwh.github.io/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>PolyNetwork跨链流程 | 来自门头沟学院的Emmanuel</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <meta name="referrer" content="no-referrer">

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">来自门头沟学院的Emmanuel</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">科研  R&B  网球</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">21</span></a>

  </li>
        <li class="menu-item menu-item-papersummary">

    <a href="/Paper-summary" rel="section"><i class="fa fa-heartbeat fa-fw"></i>PaperSummary</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/Emmanuelwh" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://emmanuelwh.github.io/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hometown.jpg">
      <meta itemprop="name" content="Emmanuel">
      <meta itemprop="description" content="XJTUer 区块链安全小白 <br> 坚信AI变革生产力  Web3变革生产关系">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="来自门头沟学院的Emmanuel">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PolyNetwork跨链流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-16 11:42:01 / Modified: 11:43:18" itemprop="dateCreated datePublished" datetime="2023-12-16T11:42:01+08:00">2023-12-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" itemprop="url" rel="index"><span itemprop="name">智能合约</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" itemprop="url" rel="index"><span itemprop="name">以太坊</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B7%A8%E9%93%BE%E6%A1%A5/" itemprop="url" rel="index"><span itemprop="name">跨链桥</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>
            <div class="post-description">摘要：Poly Network跨链流程</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Poly-Network跨链流程"><a href="#Poly-Network跨链流程" class="headerlink" title="Poly Network跨链流程"></a>Poly Network跨链流程</h1><h3 id="源链"><a href="#源链" class="headerlink" title="源链"></a>源链</h3><p>用户发起跨链交易，调用逻辑合约中的lock()函数</p>
<p>eth_contracts\contracts\core\lock_proxy\LockProxy.sol</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/* @notice                  This function is meant to be invoked by the user,</span><br><span class="line">*                           a certin amount teokens will be locked in the proxy contract the invoker/msg.sender immediately.</span><br><span class="line">*                           Then the same amount of tokens will be unloked from target chain proxy contract at the target chain with chainId later.</span><br><span class="line">*  @param fromAssetHash     The asset address in current chain, uniformly named as `fromAssetHash`</span><br><span class="line">*  @param toChainId         The target chain id</span><br><span class="line">*                           </span><br><span class="line">*  @param toAddress         The address in bytes format to receive same amount of tokens in target chain </span><br><span class="line">*  @param amount            The amount of tokens to be crossed from ethereum to the chain with chainId</span><br><span class="line">*/</span><br><span class="line">function lock(address fromAssetHash, uint64 toChainId, bytes memory toAddress, uint256 amount) public payable returns (bool) &#123;</span><br><span class="line">    require(amount != 0, &quot;amount cannot be zero!&quot;);</span><br><span class="line">    </span><br><span class="line">    //将代币合约地址锁到代理合约之中</span><br><span class="line">    require(_transferToContract(fromAssetHash, amount), &quot;transfer asset from fromAddress to lock_proxy contract  failed!&quot;);</span><br><span class="line">    </span><br><span class="line">    bytes memory toAssetHash = assetHashMap[fromAssetHash][toChainId];</span><br><span class="line">    require(toAssetHash.length != 0, &quot;empty illegal toAssetHash&quot;);</span><br><span class="line"></span><br><span class="line">    TxArgs memory txArgs = TxArgs(&#123;</span><br><span class="line">        toAssetHash: toAssetHash,</span><br><span class="line">        toAddress: toAddress,</span><br><span class="line">        amount: amount</span><br><span class="line">    &#125;);</span><br><span class="line">    bytes memory txData = _serializeTxArgs(txArgs);</span><br><span class="line">    </span><br><span class="line">    IEthCrossChainManagerProxy eccmp = IEthCrossChainManagerProxy(managerProxyContract);</span><br><span class="line">    address eccmAddr = eccmp.getEthCrossChainManager();</span><br><span class="line">    IEthCrossChainManager eccm = IEthCrossChainManager(eccmAddr);</span><br><span class="line">    </span><br><span class="line">    bytes memory toProxyHash = proxyHashMap[toChainId];</span><br><span class="line">    require(toProxyHash.length != 0, &quot;empty illegal toProxyHash&quot;);</span><br><span class="line">    require(eccm.crossChain(toChainId, toProxyHash, &quot;unlock&quot;, txData), &quot;EthCrossChainManager crossChain executed error!&quot;);</span><br><span class="line"></span><br><span class="line">    emit LockEvent(fromAssetHash, _msgSender(), toChainId, toAssetHash, toAddress, amount);</span><br><span class="line">    </span><br><span class="line">    return true;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lock()函数中会调用CCM跨链管理合约中的crossChain()函数，并emit对应LockEvent。</p>
<p>eth_contracts\contracts\core\cross_chain_manager\logic\EthCrossChainManager.sol</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function crossChain(uint64 toChainId, bytes calldata toContract, bytes calldata method, bytes calldata txData) whenNotPaused external returns (bool) &#123;</span><br><span class="line">    // Only allow whitelist contract to call</span><br><span class="line">    require(whiteListFromContract[msg.sender],&quot;Invalid from contract&quot;);</span><br><span class="line">    </span><br><span class="line">    // Load Ethereum cross chain data contract</span><br><span class="line">    IEthCrossChainData eccd = IEthCrossChainData(EthCrossChainDataAddress);</span><br><span class="line">    </span><br><span class="line">    // To help differentiate two txs, the ethTxHashIndex is increasing automatically</span><br><span class="line">    uint256 txHashIndex = eccd.getEthTxHashIndex();</span><br><span class="line">    </span><br><span class="line">    // Convert the uint256 into bytes</span><br><span class="line">    bytes memory paramTxHash = Utils.uint256ToBytes(txHashIndex);</span><br><span class="line">    </span><br><span class="line">    // Construct the makeTxParam, and put the hash info storage, to help provide proof of tx existence</span><br><span class="line">    bytes memory rawParam = abi.encodePacked(ZeroCopySink.WriteVarBytes(paramTxHash),</span><br><span class="line">        ZeroCopySink.WriteVarBytes(abi.encodePacked(sha256(abi.encodePacked(address(this), paramTxHash)))),</span><br><span class="line">        ZeroCopySink.WriteVarBytes(Utils.addressToBytes(msg.sender)),</span><br><span class="line">        ZeroCopySink.WriteUint64(toChainId),</span><br><span class="line">        ZeroCopySink.WriteVarBytes(toContract),</span><br><span class="line">        ZeroCopySink.WriteVarBytes(method),</span><br><span class="line">        ZeroCopySink.WriteVarBytes(txData)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    // Must save it in the storage to be included in the proof to be verified.</span><br><span class="line">    require(eccd.putEthTxHash(keccak256(rawParam)), &quot;Save ethTxHash by index to Data contract failed!&quot;);</span><br><span class="line">    </span><br><span class="line">    // Fire the cross chain event denoting there is a cross chain request from Ethereum network to other public chains through Poly chain network</span><br><span class="line">    emit CrossChainEvent(tx.origin, paramTxHash, msg.sender, toChainId, toContract, rawParam);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>crossChain()函数构造对应的跨链函数的交易信息，并且emit对应的跨链事件。</p>
<h3 id="Relayer"><a href="#Relayer" class="headerlink" title="Relayer"></a>Relayer</h3><h4 id="Txlisten"><a href="#Txlisten" class="headerlink" title="Txlisten"></a>Txlisten</h4><p><strong>从源链获取跨链交易消息的数据，并将其放入消息队列中</strong></p>
<p>对应的abi接口将监听对应的跨链事件,将对应的跨链事件存储到对应的迭代器中。</p>
<p>eth_contracts\go_abi\eccm_abi\eccm_abi.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FilterCrossChainEvent is a free log retrieval operation binding the contract event 0x6ad3bf15c1988bc04bc153490cab16db8efb9a3990215bf1c64ea6e28be88483.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Solidity: event CrossChainEvent(address indexed sender, bytes txId, address proxyOrAssetContract, uint64 toChainId, bytes toContract, bytes rawdata)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_EthCrossChainManager *EthCrossChainManagerFilterer)</span></span> FilterCrossChainEvent(opts *bind.FilterOpts, sender []common.Address) (*EthCrossChainManagerCrossChainEventIterator, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> senderRule []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, senderItem := <span class="keyword">range</span> sender &#123;</span><br><span class="line">		senderRule = <span class="built_in">append</span>(senderRule, senderItem)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	logs, sub, err := _EthCrossChainManager.contract.FilterLogs(opts, <span class="string">&quot;CrossChainEvent&quot;</span>, senderRule)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;EthCrossChainManagerCrossChainEventIterator&#123;contract: _EthCrossChainManager.contract, event: <span class="string">&quot;CrossChainEvent&quot;</span>, logs: logs, sub: sub&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>relayer中的scan()函数将查找在区块中的跨链交易，构造交易数据，并且调用compose()函数进一步构造交易数据</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;listener.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Listener)</span></span> Scan(height <span class="type">uint64</span>) (txs []*msg.Tx, err <span class="type">error</span>) &#123;</span><br><span class="line">	ccm, err := eccm_abi.NewEthCrossChainManager(l.ccm, l.sdk.Node())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	opt := &amp;bind.FilterOpts&#123;</span><br><span class="line">		Start:   height,</span><br><span class="line">		End:     &amp;height,</span><br><span class="line">		Context: context.Background(),</span><br><span class="line">	&#125;</span><br><span class="line">	events, err := ccm.FilterCrossChainEvent(opt, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> events == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	txs = []*msg.Tx&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> events.Next() &#123;</span><br><span class="line">		ev := events.Event</span><br><span class="line">		param := &amp;ccom.MakeTxParam&#123;&#125;</span><br><span class="line">		err = param.Deserialization(pcom.NewZeroCopySource([]<span class="type">byte</span>(ev.Rawdata)))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		tx := &amp;msg.Tx&#123;</span><br><span class="line">			TxType:     msg.SRC,</span><br><span class="line">			TxId:       msg.EncodeTxId(ev.TxId),</span><br><span class="line">			SrcHash:    ev.Raw.TxHash.String(),</span><br><span class="line">			DstChainId: ev.ToChainId,</span><br><span class="line">			SrcHeight:  height,</span><br><span class="line">			SrcParam:   hex.EncodeToString(ev.Rawdata),</span><br><span class="line">			SrcChainId: l.config.ChainId,</span><br><span class="line">			SrcProxy:   ev.ProxyOrAssetContract.String(),</span><br><span class="line">			DstProxy:   common.BytesToAddress(ev.ToContract).String(),</span><br><span class="line">			SrcAddress: ev.Sender.String(),</span><br><span class="line">		&#125;</span><br><span class="line">		l.Compose(tx)</span><br><span class="line">		txs = <span class="built_in">append</span>(txs, tx)</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// FilterCrossChainEvent is a free log retrieval operation binding the contract event 0x6ad3bf15c1988bc04bc153490cab16db8efb9a3990215bf1c64ea6e28be88483.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Solidity: event CrossChainEvent(address indexed sender, bytes txId, address proxyOrAssetContract, uint64 toChainId, bytes toContract, bytes rawdata)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_EthCrossChainManager *EthCrossChainManagerFilterer)</span></span> FilterCrossChainEvent(opts *bind.FilterOpts, sender []common.Address) (*EthCrossChainManagerCrossChainEventIterator, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> senderRule []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, senderItem := <span class="keyword">range</span> sender &#123;</span><br><span class="line">		senderRule = <span class="built_in">append</span>(senderRule, senderItem)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	logs, sub, err := _EthCrossChainManager.contract.FilterLogs(opts, <span class="string">&quot;CrossChainEvent&quot;</span>, senderRule)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;EthCrossChainManagerCrossChainEventIterator&#123;contract: _EthCrossChainManager.contract, event: <span class="string">&quot;CrossChainEvent&quot;</span>, logs: logs, sub: sub&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>compose()函数对构造跨链交易的参数进行检查，构造一些数据，调用GetProof()得到对应的交易证明</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;listener.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Listener)</span></span> Compose(tx *msg.Tx) (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(tx.SrcProofHex) &gt; <span class="number">0</span> &amp;&amp; tx.Param != <span class="literal">nil</span> &#123; <span class="comment">// Already fetched the proof</span></span><br><span class="line">		log.Info(<span class="string">&quot;Proof already fetched for tx&quot;</span>, <span class="string">&quot;hash&quot;</span>, tx.SrcHash)</span><br><span class="line">		tx.SrcProof, _ = hex.DecodeString(tx.SrcProofHex)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tx.SrcHeight == <span class="number">0</span> || <span class="built_in">len</span>(tx.TxId) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;tx missing attributes src height %v, txid %s&quot;</span>, tx.SrcHeight, tx.TxId)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(tx.SrcParam) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;src param is missing&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	event, err := hex.DecodeString(tx.SrcParam)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s submitter decode src param error %v event %s&quot;</span>, l.name, err, tx.SrcParam)</span><br><span class="line">	&#125;</span><br><span class="line">	txId, err := hex.DecodeString(tx.TxId)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s failed to decode src txid %s, err %v&quot;</span>, l.name, tx.TxId, err)</span><br><span class="line">	&#125;</span><br><span class="line">	param := &amp;ccom.MakeTxParam&#123;&#125;</span><br><span class="line">	err = param.Deserialization(pcom.NewZeroCopySource(event))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	tx.Param = param</span><br><span class="line">	tx.SrcEvent = event</span><br><span class="line">	tx.SrcProofHeight, tx.SrcProof, err = l.GetProof(txId, tx.SrcHeight)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getproof()通过对应rpc接口获取以太坊上对应的交易证明</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;listener.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Listener)</span></span> getProof(txId []<span class="type">byte</span>, txHeight <span class="type">uint64</span>) (height <span class="type">uint64</span>, proof []<span class="type">byte</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	id := msg.EncodeTxId(txId)</span><br><span class="line">	bytes, err := ceth.MappingKeyAt(id, <span class="string">&quot;01&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;%s scan event mapping key error %v&quot;</span>, l.name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	proofKey := hexutil.Encode(bytes)</span><br><span class="line">	height, err = l.GetProofHeight(txHeight)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;%s can height get proof height error %v&quot;</span>, l.name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> txHeight &gt; height &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;%w Proof not ready tx height %v proof height %v&quot;</span>, msg.ERR_PROOF_UNAVAILABLE, txHeight, height)</span><br><span class="line">		<span class="comment">// We dont return here, still fetch the proof with tx height</span></span><br><span class="line">		height = txHeight</span><br><span class="line">	&#125;</span><br><span class="line">	ethProof, e := l.sdk.Node().GetProof(l.ccd.String(), proofKey, height)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> height, <span class="literal">nil</span>, e</span><br><span class="line">	&#125;</span><br><span class="line">	proof, e = json.Marshal(ethProof)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> height, <span class="literal">nil</span>, e</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> GetProof(addr <span class="type">string</span>, key <span class="type">string</span>, height <span class="type">uint64</span>) (proof *ETHProof, err <span class="type">error</span>) &#123;</span><br><span class="line">	heightHex := hexutil.EncodeBig(big.NewInt(<span class="type">int64</span>(height)))</span><br><span class="line">	proof = &amp;ETHProof&#123;&#125;</span><br><span class="line">	err = c.Rpc.CallContext(context.Background(), &amp;proof, <span class="string">&quot;eth_getProof&quot;</span>, addr, []<span class="type">string</span>&#123;key&#125;, heightHex)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在构造完对应的跨链交易结构之后，relayer构造一个Redis数据库，存储消息队列，将对应的跨链交易存到对应的队列中。</p>
<p>poly-relayer&#x2F;bus&#x2F;sort.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SortedTxBus <span class="keyword">interface</span> &#123;</span><br><span class="line">	Push(context.Context, *msg.Tx, <span class="type">uint64</span>) <span class="type">error</span></span><br><span class="line">	Range(context.Context, <span class="type">uint64</span>, <span class="type">int64</span>) ([]*msg.Tx, <span class="type">error</span>)</span><br><span class="line">	Pop(context.Context) (*msg.Tx, <span class="type">uint64</span>, <span class="type">error</span>)</span><br><span class="line">	Len(context.Context) (<span class="type">uint64</span>, <span class="type">error</span>)</span><br><span class="line">	Topic() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RedisSortedTxBus)</span></span> Push(ctx context.Context, msg *msg.Tx, height <span class="type">uint64</span>) (err <span class="type">error</span>) &#123;</span><br><span class="line">	_, err = b.db.ZAdd(ctx, b.Key.Key(),</span><br><span class="line">		&amp;redis.Z&#123;</span><br><span class="line">			Score:  <span class="type">float64</span>(height),</span><br><span class="line">			Member: msg.Encode(),</span><br><span class="line">		&#125;,</span><br><span class="line">	).Result()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RedisSortedTxBus)</span></span> Pop(ctx context.Context) (tx *msg.Tx, score <span class="type">uint64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	res, err := b.db.BZPopMin(ctx, <span class="number">0</span>, b.Key.Key()).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	score = <span class="type">uint64</span>(res.Score)</span><br><span class="line">	tx = <span class="built_in">new</span>(msg.Tx)</span><br><span class="line">	err = tx.Decode(res.Member.(<span class="type">string</span>))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Txcommit"><a href="#Txcommit" class="headerlink" title="Txcommit"></a>Txcommit</h4><p>遍历对应的跨链交易信息队列，将跨链交易提交给Poly Chain。</p>
<p>relayer随后启动poly submitter worker，调用pop()函数将对应的跨链交易信息从队列中取出，随后调用对应的submit()函数，将对应的跨链交易信息传递到poly chain上。</p>
<p>poly-relayer&#x2F;relayer&#x2F;poly&#x2F;poly.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> Start(ctx context.Context, wg *sync.WaitGroup, mq bus.SortedTxBus, composer msg.SrcComposer) <span class="type">error</span> &#123;</span><br><span class="line">	s.composer = composer</span><br><span class="line">	s.Context = ctx</span><br><span class="line">	s.wg = wg</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.config.Procs == <span class="number">0</span> &#123;</span><br><span class="line">		s.config.Procs = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; s.config.Procs; i++ &#123;</span><br><span class="line">		log.Info(<span class="string">&quot;Starting poly submitter worker&quot;</span>, <span class="string">&quot;index&quot;</span>, i, <span class="string">&quot;procs&quot;</span>, s.config.Procs, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;topic&quot;</span>, mq.Topic())</span><br><span class="line">		<span class="keyword">go</span> s.consume(mq)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> consume(mq bus.SortedTxBus) <span class="type">error</span> &#123;</span><br><span class="line">	s.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">defer</span> s.wg.Done()</span><br><span class="line">	ticker := time.NewTicker(<span class="number">300</span> * time.Millisecond)</span><br><span class="line">	<span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">	height := s.ReadyBlock()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-s.Done():</span><br><span class="line">			log.Info(<span class="string">&quot;Submitter is exiting now&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">			h := s.ReadyBlock()</span><br><span class="line">			<span class="keyword">if</span> h &gt; <span class="number">0</span> &amp;&amp; height != h &#123;</span><br><span class="line">				height = h</span><br><span class="line">				log.Info(<span class="string">&quot;Current ready block height&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;height&quot;</span>, height)</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tx, block, err := mq.Pop(s.Context)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">&quot;Bus pop error&quot;</span>, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> tx == <span class="literal">nil</span> &#123;</span><br><span class="line">			time.Sleep(<span class="number">200</span> * time.Millisecond)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> block &lt;= height &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Processing src tx&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash, <span class="string">&quot;src_chain&quot;</span>, tx.SrcChainId, <span class="string">&quot;dst_chain&quot;</span>, tx.DstChainId)</span><br><span class="line">			err = s.submit(tx)</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Info(<span class="string">&quot;Submitted src tx to poly&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> errors.Is(err, msg.ERR_Tx_VERIFYMERKLEPROOF) &#123;</span><br><span class="line">				log.Warn(<span class="string">&quot;src tx submit to poly verifyMerkleProof failed, clear src proof&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;src hash&quot;</span>, tx.SrcHash, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">				tx.SrcProofHex = <span class="string">&quot;&quot;</span></span><br><span class="line">				tx.SrcProof = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">&quot;side chain&quot;</span>) &amp;&amp; strings.Contains(err.Error(), <span class="string">&quot;not registered&quot;</span>) &#123;</span><br><span class="line">				log.Warn(<span class="string">&quot;Submit src tx to poly error&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;err&quot;</span>, err, <span class="string">&quot;proof_height&quot;</span>, tx.SrcProofHeight)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			block = height + <span class="number">10</span></span><br><span class="line">			tx.Attempts++</span><br><span class="line">			log.Error(<span class="string">&quot;Submit src tx to poly error&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;err&quot;</span>, err, <span class="string">&quot;proof_height&quot;</span>, tx.SrcProofHeight, <span class="string">&quot;next_try&quot;</span>, block)</span><br><span class="line">			bus.SafeCall(s.Context, tx, <span class="string">&quot;push back to tx bus&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> mq.Push(context.Background(), tx, block) &#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			bus.SafeCall(s.Context, tx, <span class="string">&quot;push back to tx bus&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> mq.Push(context.Background(), tx, block) &#125;)</span><br><span class="line">			time.Sleep(<span class="number">200</span> * time.Millisecond)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>submit()函数的实现</p>
<p>首先对一些交易参数进行检查，判断是否有效，是否为空，以及交易调用的方法是否为AllowMethod。</p>
<p>随后调用poly-go-sdk中的CrossChain API将对应的交易信息和交易证明传递给Poly。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> submit(tx *msg.Tx) <span class="type">error</span> &#123;</span><br><span class="line">	err := s.composer.Compose(tx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">&quot;missing trie node&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> msg.ERR_PROOF_UNAVAILABLE</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> tx.Param == <span class="literal">nil</span> || tx.SrcChainId == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s submitter src tx %s param is missing or src chain id not specified&quot;</span>, s.name, tx.SrcHash)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !config.CONFIG.AllowMethod(tx.Param.Method) &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;Invalid src tx method&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;method&quot;</span>, tx.Param.Method)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tx.SrcStateRoot == <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.SrcStateRoot = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> account []<span class="type">byte</span></span><br><span class="line">	<span class="keyword">switch</span> tx.SrcChainId &#123;</span><br><span class="line">	<span class="keyword">case</span> base.NEO, base.ONT:</span><br><span class="line">		account = s.signer.Address[:]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(tx.SrcStateRoot) == <span class="number">0</span> || <span class="built_in">len</span>(tx.SrcProof) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s submitter src tx src state root(%x) or src proof(%x) missing for chain %d with tx %s&quot;</span>, s.name, tx.SrcStateRoot, tx.SrcProof, tx.SrcChainId, tx.SrcHash)</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">// For other chains, reversed?</span></span><br><span class="line">		account = common.Hex2Bytes(s.signer.Address.ToHexString())</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Check done tx existence</span></span><br><span class="line">		data, _ := s.sdk.Node().GetDoneTx(tx.SrcChainId, tx.Param.CrossChainID)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(data) != <span class="number">0</span> &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Tx already imported&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	t, err := s.sdk.Node().Native.Ccm.ImportOuterTransfer(</span><br><span class="line">		tx.SrcChainId,</span><br><span class="line">		tx.SrcEvent,</span><br><span class="line">		<span class="type">uint32</span>(tx.SrcProofHeight),</span><br><span class="line">		tx.SrcProof,</span><br><span class="line">		account,</span><br><span class="line">		tx.SrcStateRoot,</span><br><span class="line">		s.signer,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">&quot;tx already done&quot;</span>) &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Tx already imported&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash, <span class="string">&quot;chain&quot;</span>, tx.SrcChainId)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">&quot;verifyMerkleProof error&quot;</span>) &#123;</span><br><span class="line">			log.Error(<span class="string">&quot;Tx verifyMerkleProof err&quot;</span>, <span class="string">&quot;src_hash&quot;</span>, tx.SrcHash, <span class="string">&quot;chain&quot;</span>, tx.SrcChainId, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span> msg.ERR_Tx_VERIFYMERKLEPROOF</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Failed to import tx to poly, %v tx src hash %s&quot;</span>, err, tx.SrcHash)</span><br><span class="line">	&#125;</span><br><span class="line">	tx.PolyHash = t.ToHexString()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Poly-Chain"><a href="#Poly-Chain" class="headerlink" title="Poly Chain"></a>Poly Chain</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ChainHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">    MakeDepositProposal(service *native.NativeService) (*MakeTxParam, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数用来验证跨链交易的合法性，并将合法交易存储到Poly Chain中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *ETHHandler)</span></span> MakeDepositProposal(service *native.NativeService) (*scom.MakeTxParam, <span class="type">error</span>) &#123;</span><br><span class="line">	params := <span class="built_in">new</span>(scom.EntranceParam)</span><br><span class="line">	<span class="comment">//parse the EntranceParam from native service data</span></span><br><span class="line">	<span class="keyword">if</span> err := params.Deserialization(common.NewZeroCopySource(service.GetInput())); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;eth MakeDepositProposal, contract params deserialize error: %s&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//get registered side chain information from poly chain</span></span><br><span class="line">	sideChain, err := side_chain_manager.GetSideChain(service, params.SourceChainID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;eth MakeDepositProposal, side_chain_manager.GetSideChain error: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Verify the merkle proof and return the parsed txParam from Extra field after</span></span><br><span class="line">	value, err := verifyFromEthTx(service, params.Proof, params.Extra, params.SourceChainID, params.Height, sideChain)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;eth MakeDepositProposal, verifyFromEthTx error: %s&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Look for this tx on relay chain to make sure this tx hasn&#x27;t been executed yet</span></span><br><span class="line">	<span class="keyword">if</span> err := scom.CheckDoneTx(service, value.CrossChainID, params.SourceChainID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;eth MakeDepositProposal, check done transaction error:%s&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := scom.PutDoneTx(service, value.CrossChainID, params.SourceChainID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;eth MakeDepositProposal, PutDoneTx error:%s&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> value, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据ChainID得到对应的侧链信息，进行merkle proof的验证，返回对应解析过的txParam</p>
<p>txParam用于验证这个交易是否已经执行了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MakeTxParam <span class="keyword">struct</span> &#123;</span><br><span class="line">    TxHash              []<span class="type">byte</span></span><br><span class="line">    CrossChainID        []<span class="type">byte</span></span><br><span class="line">    FromContractAddress []<span class="type">byte</span></span><br><span class="line">    ToChainID           <span class="type">uint64</span></span><br><span class="line">    ToContractAddress   []<span class="type">byte</span></span><br><span class="line">    Method              <span class="type">string</span></span><br><span class="line">    Args                []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**MakeDepositProposal **  中主要有两个函数 <strong>verifyFromTx</strong>  和  <strong>verifyMerkleProof</strong>   </p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>verifyFromTx</td>
<td>该方法用于从Poly Chain存储的数据库中获取同步的区块头，然后调用函数verifyMerkleProof验证跨链交易的合法性</td>
</tr>
<tr>
<td>verifyMerkleProof</td>
<td>该方法用于验证交易提交的Merkle证明是否与存储在Poly中的区块头一致</td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> *  @param native       Native Service that carries values of information of cross-chain events     </span></span><br><span class="line"><span class="comment"> *  @param proof        The proof submitted by the current cross-chain transaction      </span></span><br><span class="line"><span class="comment"> *  @param extra        The cross-chain message which is used to construct MakeTxParam </span></span><br><span class="line"><span class="comment"> *  @param fromChainID  Source chain id</span></span><br><span class="line"><span class="comment"> *  @param height       The block height corresponding to the current transaction event</span></span><br><span class="line"><span class="comment"> *  @param sideChain    Source chain information that contains the ccm contract address</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyFromEthTx</span><span class="params">(native *native.NativeService, proof, extra []<span class="type">byte</span>, fromChainID <span class="type">uint64</span>, height <span class="type">uint32</span>, sideChain *cmanager.SideChain)</span></span> (*scom.MakeTxParam, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> *  @param ethProof      The proof submitted by the current cross-chain transaction </span></span><br><span class="line"><span class="comment"> *  @param blockData     The block header stored in poly chain corresponding to the current transaction event      </span></span><br><span class="line"><span class="comment"> *  @param contractAddr  The ccm contract address</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">VerifyMerkleProof</span><span class="params">(ethProof *ETHProof, blockData *eth.Header, contractAddr []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>验证通过之后，检验对应的交易信息是否已经存储在relayer chain中，若无，则将其存入relayer chain的数据库中。</p>
<h3 id="Relayer-1"><a href="#Relayer-1" class="headerlink" title="Relayer"></a>Relayer</h3><h4 id="Polylisten"><a href="#Polylisten" class="headerlink" title="Polylisten"></a>Polylisten</h4><p>relayer通过调用ScanDst()函数，通过对应的rpc接口，获取对应的跨链事件，进一步构造对应的跨链交易信息，并通过调用对应的GetProof()函数获取对应的merkle proof。</p>
<p>poly-relayer&#x2F;relayer&#x2F;poly&#x2F;listener.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Listener)</span></span> ScanDst(height <span class="type">uint64</span>) (txs []*msg.Tx, err <span class="type">error</span>) &#123;</span><br><span class="line">	txs, err = l.Scan(height)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">	sub := &amp;Submitter&#123;sdk:l.sdk&#125;</span><br><span class="line">	<span class="keyword">for</span> _, tx := <span class="keyword">range</span> txs &#123;</span><br><span class="line">		tx.MerkleValue, _, _, err = sub.GetProof(tx.PolyHeight, tx.PolyKey)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Listener)</span></span> Scan(height <span class="type">uint64</span>) (txs []*msg.Tx, err <span class="type">error</span>) &#123;</span><br><span class="line">	events, err := l.sdk.Node().GetSmartContractEventByBlock(<span class="type">uint32</span>(height))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, event := <span class="keyword">range</span> events &#123;</span><br><span class="line">		<span class="keyword">for</span> _, notify := <span class="keyword">range</span> event.Notify &#123;</span><br><span class="line">			<span class="keyword">if</span> notify.ContractAddress == poly.CCM_ADDRESS &#123;</span><br><span class="line">				states := notify.States.([]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(states) &lt; <span class="number">6</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				method, _ := states[<span class="number">0</span>].(<span class="type">string</span>)</span><br><span class="line">				<span class="keyword">if</span> method != <span class="string">&quot;makeProof&quot;</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				dstChain := <span class="type">uint64</span>(states[<span class="number">2</span>].(<span class="type">float64</span>))</span><br><span class="line">				<span class="keyword">if</span> dstChain == <span class="number">0</span> &#123;</span><br><span class="line">					log.Error(<span class="string">&quot;Invalid dst chain id in poly tx&quot;</span>, <span class="string">&quot;hash&quot;</span>, event.TxHash)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				tx := <span class="built_in">new</span>(msg.Tx)</span><br><span class="line">				tx.DstChainId = dstChain</span><br><span class="line">				tx.PolyKey = states[<span class="number">5</span>].(<span class="type">string</span>)</span><br><span class="line">				tx.PolyHeight = <span class="type">uint32</span>(height)</span><br><span class="line">				tx.PolyHash = event.TxHash</span><br><span class="line">				tx.TxType = msg.POLY</span><br><span class="line">				tx.TxId = states[<span class="number">3</span>].(<span class="type">string</span>)</span><br><span class="line">				tx.SrcChainId = <span class="type">uint64</span>(states[<span class="number">1</span>].(<span class="type">float64</span>))</span><br><span class="line">				<span class="keyword">switch</span> tx.SrcChainId &#123;</span><br><span class="line">				<span class="keyword">case</span> base.NEO, base.NEO3, base.ONT:</span><br><span class="line">					tx.TxId = util.ReverseHex(tx.TxId)</span><br><span class="line">				&#125;</span><br><span class="line">				txs = <span class="built_in">append</span>(txs, tx)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过对应的poly-go-sdk中的API接口，获取对应的交易证明</p>
<p>poly-relayer&#x2F;relayer&#x2F;poly&#x2F;compose.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> GetProof(height <span class="type">uint32</span>, key <span class="type">string</span>) (param *ccom.ToMerkleValue, auditPath <span class="type">string</span>, evt *scom.SmartContactEvent, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> s.getProof(s.sdk.Node(), height, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> getProof(node *poly.Client, height <span class="type">uint32</span>, key <span class="type">string</span>) (param *ccom.ToMerkleValue, auditPath <span class="type">string</span>, evt *scom.SmartContactEvent, err <span class="type">error</span>) &#123;</span><br><span class="line">	proof, err := node.GetCrossStatesProof(height, key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;GetProof: GetCrossStatesProof key %s, error %v&quot;</span>, key, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	auditPath = proof.AuditPath</span><br><span class="line">	path, err := hex.DecodeString(proof.AuditPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	value, _, _, _ := msg.ParseAuditPath(path)</span><br><span class="line">	param = <span class="built_in">new</span>(ccom.ToMerkleValue)</span><br><span class="line">	err = param.Deserialization(pcom.NewZeroCopySource(value))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;GetPolyParams: param.Deserialization error %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后的过程，与前一个relayer类似，将对应的跨链消息以队列的形式存入到Redis数据库中。</p>
<h4 id="PolyCommit"><a href="#PolyCommit" class="headerlink" title="PolyCommit"></a>PolyCommit</h4><p>realyer调用start()函数启动对应的submitter，循环从队列中Pop出对应的跨链消息。</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;eth.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> run(account accounts.Account, mq bus.TxBus, delay bus.DelayedTxBus, compose msg.PolyComposer) <span class="type">error</span> &#123;</span><br><span class="line">	s.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">defer</span> s.wg.Done()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-s.Done():</span><br><span class="line">			log.Info(<span class="string">&quot;Submitter is exiting now&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line">		tx, err := mq.Pop(s.Context)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">&quot;Bus pop error&quot;</span>, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> tx == <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;Bus pop nil?&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Info(<span class="string">&quot;Processing poly tx&quot;</span>, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash, <span class="string">&quot;account&quot;</span>, account.Address)</span><br><span class="line">		tx.DstSender = &amp;account</span><br><span class="line">		err = s.ProcessTx(tx, compose)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			err = s.SubmitTx(tx)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">&quot;Process poly tx error&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">			log.Json(log.ERROR, tx)</span><br><span class="line">			<span class="keyword">if</span> errors.Is(err, msg.ERR_INVALID_TX) || errors.Is(err, msg.ERR_TX_BYPASS) &#123;</span><br><span class="line">				log.Error(<span class="string">&quot;Skipped poly tx for error&quot;</span>, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			tx.Attempts++</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> retry with increased gas price?</span></span><br><span class="line">			<span class="keyword">if</span> errors.Is(err, msg.ERR_TX_EXEC_FAILURE) || errors.Is(err, msg.ERR_TX_EXEC_ALWAYS_FAIL) &#123;</span><br><span class="line">				tsp := time.Now().Unix() + <span class="number">60</span>*<span class="number">3</span></span><br><span class="line">				bus.SafeCall(s.Context, tx, <span class="string">&quot;push to delay queue&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> delay.Delay(context.Background(), tx, tsp) &#125;)</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, msg.ERR_FEE_CHECK_FAILURE) &#123;</span><br><span class="line">				tsp := time.Now().Unix() + <span class="number">10</span></span><br><span class="line">				bus.SafeCall(s.Context, tx, <span class="string">&quot;push to delay queue&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> delay.Delay(context.Background(), tx, tsp) &#125;)</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, msg.ERR_PAID_FEE_TOO_LOW) &#123;</span><br><span class="line">				tsp := time.Now().Unix() + <span class="number">60</span>*<span class="number">10</span></span><br><span class="line">				bus.SafeCall(s.Context, tx, <span class="string">&quot;push to delay queue&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> delay.Delay(context.Background(), tx, tsp) &#125;)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				tsp := time.Now().Unix() + <span class="number">1</span></span><br><span class="line">				bus.SafeCall(s.Context, tx, <span class="string">&quot;push to delay queue&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> delay.Delay(context.Background(), tx, tsp) &#125;)</span><br><span class="line">				<span class="keyword">if</span> errors.Is(err, msg.ERR_LOW_BALANCE) &#123;</span><br><span class="line">					log.Info(<span class="string">&quot;Low wallet balance detected&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;account&quot;</span>, account.Address)</span><br><span class="line">					s.WaitForBalance(account.Address)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Submitted poly tx&quot;</span>, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;dst_hash&quot;</span>, tx.DstHash)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Retry to verify a successful submit</span></span><br><span class="line">			tsp := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">			<span class="keyword">switch</span> s.config.ChainId &#123;</span><br><span class="line">			<span class="keyword">case</span> base.MATIC, base.PLT:</span><br><span class="line">				tsp = time.Now().Unix() + <span class="number">60</span>*<span class="number">3</span></span><br><span class="line">			<span class="keyword">case</span> base.ARBITRUM, base.OPTIMISM:</span><br><span class="line">				tsp = time.Now().Unix() + <span class="number">60</span>*<span class="number">25</span></span><br><span class="line">			<span class="keyword">case</span> base.BSC, base.HECO, base.OK, base.KCC, base.BYTOM, base.HSC, base.MILKO:</span><br><span class="line">				tsp = time.Now().Unix() + <span class="number">60</span>*<span class="number">4</span></span><br><span class="line">			<span class="keyword">case</span> base.ETH:</span><br><span class="line">				tsp = time.Now().Unix() + <span class="number">60</span>*<span class="number">6</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				tsp = time.Now().Unix() + <span class="number">60</span>*<span class="number">3</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> tsp &gt; <span class="number">0</span> &amp;&amp; tx.DstHash != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">				bus.SafeCall(s.Context, tx, <span class="string">&quot;push to delay queue&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> delay.Delay(context.Background(), tx, tsp) &#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>relayer随后调用ProcessTx()函数，对对应的跨链函数进行处理，这里会检验对应的跨链交易是否已经传递给了目标链，随后会构造调用以太坊上’verifyHeaderAndExecuteTx’函数的数据，将其存储到对应的tx数据之中。</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;eth.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> processPolyTx(tx *msg.Tx) (err <span class="type">error</span>) &#123;</span><br><span class="line">	ccd, err := eccd_abi.NewEthCrossChainData(s.ccd, s.sdk.Node())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	txId := [<span class="number">32</span>]<span class="type">byte</span>&#123;&#125;</span><br><span class="line">	<span class="built_in">copy</span>(txId[:], tx.MerkleValue.TxHash[:<span class="number">32</span>])</span><br><span class="line">	exist, err := ccd.CheckIfFromChainTxExist(<span class="literal">nil</span>, tx.SrcChainId, txId)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> exist &#123;</span><br><span class="line">		log.Info(<span class="string">&quot;ProcessPolyTx dst tx already relayed, tx id occupied&quot;</span>, <span class="string">&quot;chain&quot;</span>, s.name, <span class="string">&quot;poly_hash&quot;</span>, tx.PolyHash)</span><br><span class="line">		tx.DstHash = <span class="string">&quot;&quot;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proof, err := hex.DecodeString(tx.AnchorProof)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s processPolyTx decode anchor proof hex error %v&quot;</span>, s.name, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> anchor []<span class="type">byte</span></span><br><span class="line">	<span class="keyword">if</span> tx.AnchorHeader != <span class="literal">nil</span> &#123;</span><br><span class="line">		anchor = tx.AnchorHeader.GetMessage()</span><br><span class="line">	&#125;</span><br><span class="line">	path, err := hex.DecodeString(tx.AuditPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s failed to decode audit path %v&quot;</span>, s.name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	tx.DstData, err = s.abi.Pack(<span class="string">&quot;verifyHeaderAndExecuteTx&quot;</span>, path, tx.PolyHeader.GetMessage(), proof, anchor, tx.PolySigs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;%s processPolyTx pack tx error %v&quot;</span>, s.name, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> ProcessTx(m *msg.Tx, compose msg.PolyComposer) (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> m.Type() != msg.POLY &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s desired message is not poly tx %v&quot;</span>, m.Type())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> m.DstChainId != s.config.ChainId &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s message dst chain does not match %v&quot;</span>, m.DstChainId)</span><br><span class="line">	&#125;</span><br><span class="line">	m.DstPolyEpochStartHeight, err = s.GetPolyEpochStartHeight()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s fetch dst chain poly epoch height error %v&quot;</span>, s.name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	m.DstPolyKeepers, err = s.GetPolyKeepers()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s fetch dst chain poly keepers error %v&quot;</span>, s.name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	err = compose(m)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	err = s.processPolyTx(m)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CheckIfFromChainTxExist is a free data retrieval call binding the contract method 0x0586763c.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Solidity: function checkIfFromChainTxExist(uint64 fromChainId, bytes32 fromChainTx) view returns(bool)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_EthCrossChainData *EthCrossChainDataCaller)</span></span> CheckIfFromChainTxExist(opts *bind.CallOpts, fromChainId <span class="type">uint64</span>, fromChainTx [<span class="number">32</span>]<span class="type">byte</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		ret0 = <span class="built_in">new</span>(<span class="type">bool</span>)</span><br><span class="line">	)</span><br><span class="line">	out := ret0</span><br><span class="line">	err := _EthCrossChainData.contract.Call(opts, out, <span class="string">&quot;checkIfFromChainTxExist&quot;</span>, fromChainId, fromChainTx)</span><br><span class="line">	<span class="keyword">return</span> *ret0, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>relayer将对应的交易数据构造处理后之后，调用对应的SubmitTx()函数，来将对应的交易信息传递给目标链。</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;eth.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> SubmitTx(tx *msg.Tx) (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">switch</span> v := tx.DstSender.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">		<span class="keyword">for</span> _, a := <span class="keyword">range</span> s.wallet.Accounts() &#123;</span><br><span class="line">			<span class="keyword">if</span> util.LowerHex(a.Address.String()) == util.LowerHex(v) &#123;</span><br><span class="line">				tx.DstSender = &amp;a</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	err = s.submit(tx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		info := err.Error()</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(info, <span class="string">&quot;business contract failed&quot;</span>) &#123;</span><br><span class="line">			err = fmt.Errorf(<span class="string">&quot;%w tx exec error %v&quot;</span>, msg.ERR_TX_EXEC_FAILURE, err)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(info, <span class="string">&quot;higher than max limit&quot;</span>) || strings.Contains(info, <span class="string">&quot;max limit is zero or missing&quot;</span>) &#123;</span><br><span class="line">			err = fmt.Errorf(<span class="string">&quot;%w %v&quot;</span>, msg.ERR_PAID_FEE_TOO_LOW, err)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(info, <span class="string">&quot;always failing&quot;</span>) &#123;</span><br><span class="line">			err = fmt.Errorf(<span class="string">&quot;%w tx exec error %v&quot;</span>, msg.ERR_TX_EXEC_ALWAYS_FAIL, err)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(info, <span class="string">&quot;insufficient funds&quot;</span>) || strings.Contains(info, <span class="string">&quot;exceeds allowance&quot;</span>) &#123;</span><br><span class="line">			err = msg.ERR_LOW_BALANCE</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用submit()函数将，在目标链上发起对应的跨链交易。</p>
<p>poly-relayer&#x2F;relayer&#x2F;eth&#x2F;eth.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Submitter)</span></span> submit(tx *msg.Tx) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(tx.DstData) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		gasPrice  *big.Int</span><br><span class="line">		gasPriceX *big.Float</span><br><span class="line">		ok        <span class="type">bool</span></span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> tx.DstGasPrice != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		gasPrice, ok = <span class="built_in">new</span>(big.Int).SetString(tx.DstGasPrice, <span class="number">10</span>)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s submit invalid gas price %s&quot;</span>, tx.DstGasPrice)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> tx.DstGasPriceX != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		gasPriceX, ok = <span class="built_in">new</span>(big.Float).SetString(tx.DstGasPriceX)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s submit invalid gas priceX %s&quot;</span>, tx.DstGasPriceX)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		err     <span class="type">error</span></span><br><span class="line">		account accounts.Account</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> tx.DstSender != <span class="literal">nil</span> &#123;</span><br><span class="line">		acc := tx.DstSender.(*accounts.Account)</span><br><span class="line">		account = *acc</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		account, _, _ = s.wallet.Select()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tx.CheckFeeOff || tx.CheckFeeStatus != bridge.PAID_LIMIT &#123;</span><br><span class="line">		tx.DstHash, err = s.wallet.SendWithAccount(account, s.ccm, big.NewInt(<span class="number">0</span>), tx.DstGasLimit, gasPrice, gasPriceX, tx.DstData)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		maxLimit, _ := big.NewFloat(tx.PaidGas).Int(<span class="literal">nil</span>)</span><br><span class="line">		tx.DstHash, err = s.wallet.SendWithMaxLimit(s.sdk.ChainID, account, s.ccm, big.NewInt(<span class="number">0</span>), maxLimit, gasPrice, gasPriceX, tx.DstData)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用SendWithAccount()向以太坊上发送对应的交易</p>
<p>bridge-common&#x2F;wallet&#x2F;eth.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> gasPrice, gasPriceX used as gas tip here!</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *EthWallet)</span></span> SendWithAccount(account accounts.Account, addr common.Address, amount *big.Int, gasLimit <span class="type">uint64</span>, gasPrice *big.Int, gasPriceX *big.Float, data []<span class="type">byte</span>) (hash <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> gasPrice == <span class="literal">nil</span> || gasPrice.Sign() &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		gasPrice, err = w.GasTip()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			err = fmt.Errorf(<span class="string">&quot;Get gas tip error %v&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> gasPriceX != <span class="literal">nil</span> &#123;</span><br><span class="line">			gasPrice, _ = <span class="built_in">new</span>(big.Float).Mul(<span class="built_in">new</span>(big.Float).SetInt(gasPrice), gasPriceX).Int(<span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gasCap, err := w.GasPrice()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;Get gas price error %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Make this configurable</span></span><br><span class="line">	gasCap = big.NewInt(<span class="number">0</span>).Quo(big.NewInt(<span class="number">0</span>).Mul(gasCap, big.NewInt(<span class="number">30</span>)), big.NewInt(<span class="number">10</span>)) <span class="comment">// max gas price</span></span><br><span class="line"></span><br><span class="line">	provider, nonces := w.GetAccount(account)</span><br><span class="line">	nonce, err := nonces.Acquire()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> gasLimit == <span class="number">0</span> &#123;</span><br><span class="line">		msg := ethereum.CallMsg&#123;</span><br><span class="line">			From: account.Address, To: &amp;addr, Value: big.NewInt(<span class="number">0</span>), Data: data,</span><br><span class="line">			GasFeeCap: gasCap, GasTipCap: gasPrice,</span><br><span class="line">		&#125;</span><br><span class="line">		gasLimit, err = w.sdk.Node().EstimateGas(context.Background(), msg)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			nonces.Update(<span class="literal">false</span>)</span><br><span class="line">			<span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">&quot;has been executed&quot;</span>) &#123;</span><br><span class="line">				log.Info(<span class="string">&quot;Transaction already executed&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;Estimate gas limit error %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gasLimit = <span class="type">uint64</span>(<span class="number">1.3</span> * <span class="type">float32</span>(gasLimit))</span><br><span class="line">	limit := GetChainGasLimit(w.chainId, gasLimit)</span><br><span class="line">	<span class="keyword">if</span> limit &lt; gasLimit &#123;</span><br><span class="line">		nonces.Update(<span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;Send tx estimated gas limit(%v) higher than max %v&quot;</span>, gasLimit, limit)</span><br><span class="line">	&#125;</span><br><span class="line">	tx := types.NewTx(&amp;types.DynamicFeeTx&#123;</span><br><span class="line">		Nonce:     nonce,</span><br><span class="line">		GasTipCap: gasPrice,</span><br><span class="line">		GasFeeCap: gasCap,</span><br><span class="line">		Gas:       limit,</span><br><span class="line">		To:        &amp;addr,</span><br><span class="line">		Value:     amount,</span><br><span class="line">		Data:      data,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// tx := types.NewTransaction(nonce, addr, amount, limit, gasPrice, data)</span></span><br><span class="line">	tx, err = provider.SignTx(account, tx, big.NewInt(<span class="type">int64</span>(w.chainId)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		nonces.Update(<span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;Sign tx error %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Info(<span class="string">&quot;Compose dst chain tx&quot;</span>, <span class="string">&quot;hash&quot;</span>, tx.Hash(), <span class="string">&quot;account&quot;</span>, account.Address, <span class="string">&quot;nonce&quot;</span>, tx.Nonce(), <span class="string">&quot;limit&quot;</span>, tx.Gas(), <span class="string">&quot;gasPrice&quot;</span>, tx.GasPrice())</span><br><span class="line">	err = w.sdk.Node().SendTransaction(context.Background(), tx)</span><br><span class="line">	<span class="comment">//<span class="doctag">TODO:</span> Check err here before update nonces</span></span><br><span class="line">	nonces.Update(<span class="literal">true</span>)</span><br><span class="line">	<span class="keyword">return</span> tx.Hash().String(), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>go-ethereum&#x2F;ethclient&#x2F;ethclient.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ec *Client)</span></span> SendTransaction(ctx context.Context, tx *types.Transaction) <span class="type">error</span> &#123;</span><br><span class="line">	data, err := tx.MarshalBinary()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ec.c.CallContext(ctx, <span class="literal">nil</span>, <span class="string">&quot;eth_sendRawTransaction&quot;</span>, hexutil.Encode(data))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过json-rpc接口，发起在以太坊上的函数调用</p>
<p>go-ethereum&#x2F;rpc&#x2F;client.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CallContext performs a JSON-RPC call with the given arguments. If the context is</span></span><br><span class="line"><span class="comment">// canceled before the call has successfully returned, CallContext returns immediately.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The result must be a pointer so that package json can unmarshal into it. You</span></span><br><span class="line"><span class="comment">// can also pass nil, in which case the result is ignored.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> CallContext(ctx context.Context, result <span class="keyword">interface</span>&#123;&#125;, method <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="目标链"><a href="#目标链" class="headerlink" title="目标链"></a>目标链</h3><p>验证对应的区块头和<strong>Merkle proof</strong> ，验证通过，交易在目标链上执行。</p>
<ul>
<li><p>中继器调用该函数，一些情况，用户从<strong>Poly</strong>链获取有效的块信息，自行调用该方法</p>
</li>
<li><p>该方法获取并处理跨链交易，得到对应交易的<strong>Merkle</strong>根，使用交易参数来验证交易的合法性</p>
</li>
<li><p>验证Poly Chain区块头和证明后，检查参数<strong>toContract</strong> 和<strong>toMerkleValue.makeTxParam.method</strong> 是否已经在白名单中</p>
</li>
<li><p>然后调用部署在目标链上的业务逻辑合约，通过内部方法**_executeCrossChainTx()**对业务逻辑合约进行处理：</p>
<ul>
<li>该方法旨在调用目标合约并触发目标链上跨链交易的执行。</li>
<li>首先，您需要确保目标合约正在等待调用合约而不是标准账户地址。</li>
<li>然后构造一个目标业务逻辑契约方法：需要对_method和输入数据格式“(bytes,bytes,uint64)”进行<strong>encodePacked</strong></li>
<li>然后它会<strong>keccak256</strong>编码的字符串，使用 <strong>bytes4</strong> 获取函数调用的调用数据的前四个字节，指定要调用的函数。</li>
</ul>
</li>
<li><p>调用方法后，需要检查返回值。  只有返回值为真，整个跨链交易才会执行成功</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">/*  </span><br><span class="line"> *  @param proof                  Poly chain transaction Merkle proof</span><br><span class="line"> *  @param rawHeader              The header containing crossStateRoot to verify the above tx Merkle proof</span><br><span class="line"> *  @param headerProof            The header Merkle proof used to verify rawHeader</span><br><span class="line"> *  @param curRawHeader           Any header in current epoch consensus of Poly chain</span><br><span class="line"> *  @param headerSig              The converted signature variable for solidity derived from Poly chain consensus nodes&#x27; signature </span><br><span class="line"> *                                used to verify the validity of curRawHeader</span><br><span class="line"> *  @return                       true or false</span><br><span class="line">*/</span><br><span class="line">function verifyHeaderAndExecuteTx(bytes memory proof, bytes memory rawHeader, bytes memory headerProof, bytes memory curRawHeader,bytes memory headerSig) whenNotPaused public returns (bool)&#123;</span><br><span class="line">    ECCUtils.Header memory header = ECCUtils.deserializeHeader(rawHeader);</span><br><span class="line">    // Load ehereum cross chain data contract</span><br><span class="line">    IEthCrossChainData eccd = IEthCrossChainData(EthCrossChainDataAddress);</span><br><span class="line"></span><br><span class="line">    // Get stored consensus public key bytes of current Poly chain epoch and deserialize Poly chain consensus public key bytes to address[]</span><br><span class="line">    address[] memory polyChainBKs = ECCUtils.deserializeKeepers(eccd.getCurEpochConPubKeyBytes());</span><br><span class="line"></span><br><span class="line">    uint256 curEpochStartHeight = eccd.getCurEpochStartHeight();</span><br><span class="line"></span><br><span class="line">    uint n = polyChainBKs.length;</span><br><span class="line">    if (header.height &gt;= curEpochStartHeight) &#123;</span><br><span class="line">        // It&#x27;s enough to verify rawHeader signature</span><br><span class="line">        require(ECCUtils.verifySig(rawHeader, headerSig, polyChainBKs, n - ( n - 1) / 3), &quot;Verify Poly chain header signature failed!&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // We need to verify the signature of curHeader </span><br><span class="line">        require(ECCUtils.verifySig(curRawHeader, headerSig, polyChainBKs, n - ( n - 1) / 3), &quot;Verify Poly chain current epoch header signature failed!&quot;);</span><br><span class="line"></span><br><span class="line">        // Then use curHeader.StateRoot and headerProof to verify rawHeader.CrossStateRoot</span><br><span class="line">        ECCUtils.Header memory curHeader = ECCUtils.deserializeHeader(curRawHeader);</span><br><span class="line">        bytes memory proveValue = ECCUtils.MerkleProve(headerProof, curHeader.blockRoot);</span><br><span class="line">        require(ECCUtils.getHeaderHash(rawHeader) == Utils.bytesToBytes32(proveValue), &quot;verify header proof failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Through rawHeader.CrossStatesRoot, the toMerkleValue or cross chain msg can be verified and parsed from proof</span><br><span class="line">    bytes memory toMerkleValueBs = ECCUtils.MerkleProve(proof, header.crossStatesRoot);</span><br><span class="line"></span><br><span class="line">    // Parse the toMerkleValue struct and make sure the tx has not been processed, then mark this tx as processed</span><br><span class="line">    ECCUtils.ToMerkleValue memory toMerkleValue = ECCUtils.deserializeMerkleValue(toMerkleValueBs);</span><br><span class="line">    require(!eccd.checkIfFromChainTxExist(toMerkleValue.fromChainID, Utils.bytesToBytes32(toMerkleValue.txHash)), &quot;the transaction has been executed!&quot;);</span><br><span class="line">    require(eccd.markFromChainTxExist(toMerkleValue.fromChainID, Utils.bytesToBytes32(toMerkleValue.txHash)), &quot;Save crosschain tx exist failed!&quot;);</span><br><span class="line"></span><br><span class="line">    // Ethereum ChainId is 2, we need to check the transaction is for Ethereum network</span><br><span class="line">    require(toMerkleValue.makeTxParam.toChainId == chainId, &quot;This Tx is not aiming at this network!&quot;);</span><br><span class="line"></span><br><span class="line">    // Obtain the target contract, so that Ethereum cross chain manager contract can trigger the executation of cross chain tx on Ethereum side</span><br><span class="line">    address toContract = Utils.bytesToAddress(toMerkleValue.makeTxParam.toContract);</span><br><span class="line"></span><br><span class="line">    // only invoke PreWhiteListed Contract and method For Now</span><br><span class="line">    require(whiteListContractMethodMap[toContract][toMerkleValue.makeTxParam.method],&quot;Invalid to contract or method&quot;);</span><br><span class="line"></span><br><span class="line">    //TODO: check this part to make sure we commit the next line when doing local net UT test</span><br><span class="line">    require(_executeCrossChainTx(toContract, toMerkleValue.makeTxParam.method, toMerkleValue.makeTxParam.args, toMerkleValue.makeTxParam.fromContract, toMerkleValue.fromChainID), &quot;Execute CrossChain Tx failed!&quot;);</span><br><span class="line"></span><br><span class="line">    // Fire the cross chain event denoting the executation of cross chain tx is successful,</span><br><span class="line">    // and this tx is coming from other public chains to current Ethereum network</span><br><span class="line">    emit VerifyHeaderAndExecuteTxEvent(toMerkleValue.fromChainID, toMerkleValue.makeTxParam.toContract, toMerkleValue.txHash, toMerkleValue.makeTxParam.txHash);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* </span><br><span class="line"> *  @notice                       Dynamically invoke the target contract, trigger execution of cross-chain tx </span><br><span class="line">                                  on Ethereum side</span><br><span class="line"> *  @param _toContract            the Ethereum Cross Chain Manager contract will invoke the target contract</span><br><span class="line"> *  @param _method                At which method will be invoked within the target contract</span><br><span class="line"> *  @param _args                  The parameter that will be passed into the target contract</span><br><span class="line"> *  @param _fromContractAddr      From chain smart contract address</span><br><span class="line"> *  @param _fromChainId           Indicate from which chain current cross-chain tx comes </span><br><span class="line"> *  @return                       true or false</span><br><span class="line">*/</span><br><span class="line">function _executeCrossChainTx(address _toContract, bytes memory _method, bytes memory _args, bytes memory _fromContractAddr, uint64 _fromChainId) internal returns (bool)&#123;</span><br><span class="line">    // Ensure the target contract gonna be invoked is indeed a contract rather than a normal account address</span><br><span class="line">    require(Utils.isContract(_toContract), &quot;The passed in address is not a contract!&quot;);</span><br><span class="line">    bytes memory returnData;</span><br><span class="line">    bool success;</span><br><span class="line"></span><br><span class="line">    // The returnData will be bytes32, the last byte must be 01;</span><br><span class="line">    (success, returnData) = _toContract.call(abi.encodePacked(bytes4(keccak256(abi.encodePacked(_method, &quot;(bytes,bytes,uint64)&quot;))), abi.encode(_args, _fromContractAddr, _fromChainId)));</span><br><span class="line"></span><br><span class="line">    // Ensure the executation is successful</span><br><span class="line">    require(success == true, &quot;EthCrossChain call business contract failed&quot;);</span><br><span class="line"></span><br><span class="line">    // Ensure the returned value is true</span><br><span class="line">    require(returnData.length != 0, &quot;No return value from business contract!&quot;);</span><br><span class="line">    (bool res,) = ZeroCopySource.NextBool(returnData, 31);</span><br><span class="line">    require(res == true, &quot;EthCrossChain call business contract return is not true&quot;);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

    </div>

    
    
    
      
  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\12\16\跨链桥安全事件总结分析\" rel="bookmark">跨链桥安全事件总结分析</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\12\16\PolyNetwork以太坊智能合约介绍\" rel="bookmark">PolyNetwork以太坊智能合约介绍</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Emmanuel
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://emmanuelwh.github.io/2023/12/16/PolyNetwork%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B/" title="PolyNetwork跨链流程">https://emmanuelwh.github.io/2023/12/16/PolyNetwork跨链流程/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%B7%A8%E9%93%BE%E6%A1%A5/" rel="tag"># 跨链桥</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/12/16/%E8%B7%A8%E9%93%BE%E6%A1%A5%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BB%93%E5%88%86%E6%9E%90/" rel="prev" title="跨链桥安全事件总结分析">
      <i class="fa fa-chevron-left"></i> 跨链桥安全事件总结分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/12/16/%E4%BB%B7%E6%A0%BC%E6%93%8D%E7%BA%B5%E6%94%BB%E5%87%BB%E5%86%8D%E7%90%86%E8%A7%A3/" rel="next" title="价格操纵攻击再理解">
      价格操纵攻击再理解 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Poly-Network%E8%B7%A8%E9%93%BE%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Poly Network跨链流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E9%93%BE"><span class="nav-number">1.0.1.</span> <span class="nav-text">源链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Relayer"><span class="nav-number">1.0.2.</span> <span class="nav-text">Relayer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Txlisten"><span class="nav-number">1.0.2.1.</span> <span class="nav-text">Txlisten</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Txcommit"><span class="nav-number">1.0.2.2.</span> <span class="nav-text">Txcommit</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Poly-Chain"><span class="nav-number">1.0.3.</span> <span class="nav-text">Poly Chain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Relayer-1"><span class="nav-number">1.0.4.</span> <span class="nav-text">Relayer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Polylisten"><span class="nav-number">1.0.4.1.</span> <span class="nav-text">Polylisten</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PolyCommit"><span class="nav-number">1.0.4.2.</span> <span class="nav-text">PolyCommit</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E9%93%BE"><span class="nav-number">1.0.5.</span> <span class="nav-text">目标链</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Emmanuel"
      src="/images/hometown.jpg">
  <p class="site-author-name" itemprop="name">Emmanuel</p>
  <div class="site-description" itemprop="description">XJTUer 区块链安全小白 <br> 坚信AI变革生产力  Web3变革生产关系</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Emmanuelwh" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Emmanuelwh" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/emmanuel-87-70" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;emmanuel-87-70" rel="noopener" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/m0_53689197?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;m0_53689197?type&#x3D;blog" rel="noopener" target="_blank"><i class="far fa-keyboard fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://music.163.com/#/user/home?id=2071923556" title="Music → https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;2071923556" rel="noopener" target="_blank"><i class="fab fa-itunes-note fa-fw"></i>Music</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <!-- require APlayer -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
        <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
        <!-- require MetingJS-->
        <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script> 
      <!--网易云-->   
        <div class="aplayer" 
          data-id="8940934500" 
          data-server="netease" 
          data-type="playlist" 
          data-fixed="false" 
          data-autoplay="true" 
          data-list-folded="false"
          data-mutex="true"
          data-order="random" 
          data-loop="all"
          data-volume="0.4" 
          data-theme="#FADFA3" 
          date-preload="auto" > 
        </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Emmanuel</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">33k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">1:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.bootcss.com/valine/1.4.4/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = '';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'gAD7uMtmIxpFIANjozCCYSex-gzGzoHsz',
      appKey     : '7NgcIb6pbECV8SqPakVb2uc1',
      placeholder: "聊五毛钱的天嘛？|ω･)و ̑̑༉",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>

  
   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"position":"right","width":250,"height":400,"hOffset":5,"vOffset":50},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
